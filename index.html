<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Race Visualizer</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1e1e2f; color: #f5f5f5; display: flex; flex-direction: column; align-items: center; }
    header { background: linear-gradient(135deg, #222 40%, #444); width: 100%; padding: 2rem 1rem; text-align: center; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6); }
    header h1 { margin: 0; font-size: 2.5rem; color: #ffd700; letter-spacing: 1px; }
    .container { width: 100%; max-width: 1200px; padding: 2rem; }
    .container h2 { width: 100%; text-align: left; margin: 2rem 0 1rem; color: #ffd700; border-bottom: 1px solid #444; padding-bottom: 0.3rem; }
    .course-group { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; }
    .card { background: #2c2c3e; border-radius: 12px; padding: 1.5rem; text-align: center; width: 220px; transition: transform 0.2s ease, box-shadow 0.3s ease; box-shadow: 0 0 10px rgba(255, 255, 255, 0.05); }
    .card:hover { transform: translateY(-6px); box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
    .card a { text-decoration: none; color: #ffd700; font-weight: bold; font-size: 1.1rem; display: inline-block; }

    /* ‚úÖ meta row + badges */
    .meta-row { margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.4rem; justify-content: center; }
    .badge {
      font-size: 0.78rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: #ddd;
      line-height: 1.2;
      white-space: nowrap;
    }
    .badge-ep { background: rgba(0, 200, 255, 0.14); border-color: rgba(0, 200, 255, 0.25); color: #bfefff; }
    .badge-hi { background: rgba(60, 220, 120, 0.14); border-color: rgba(60, 220, 120, 0.25); color: #c8ffd8; }
    .badge-lo { background: rgba(255, 120, 120, 0.14); border-color: rgba(255, 120, 120, 0.25); color: #ffd1d1; }

    footer { margin-top: 3rem; font-size: 0.9rem; color: #888; text-align: center; padding-bottom: 2rem; }
    @media (max-width: 600px) { .card { width: 90%; } header h1 { font-size: 1.8rem; } }
  </style>
</head>
<body>
  <header>
    <h1>üèá Race Visualizer Index</h1>
  </header>

  <div class="container">
    <h2>üèÅ Newcastle</h2>
    <div class="course-group">
      <div class="card"><a href="17-12_Newcastle.html">17:12 Newcastle</a></div>
      <div class="card"><a href="17-42_Newcastle.html">17:42 Newcastle</a></div>
    </div>

    <h2>üèÅ Southwell</h2>
    <div class="course-group">
      <div class="card"><a href="17-00_Southwell.html">17:00 Southwell</a></div>
      <div class="card"><a href="17-30_Southwell.html">17:30 Southwell</a></div>
      <div class="card"><a href="18-00_Southwell.html">18:00 Southwell</a></div>
      <div class="card"><a href="18-30_Southwell.html">18:30 Southwell</a></div>
      <div class="card"><a href="19-00_Southwell.html">19:00 Southwell</a></div>
      <div class="card"><a href="19-30_Southwell.html">19:30 Southwell</a></div>
      <div class="card"><a href="20-00_Southwell.html">20:00 Southwell</a></div>
    </div>

    <h2>üèÅ best_bets</h2>
    <div class="course-group">
      <div class="card"><a href="ai_best_bets.html">ai best_bets</a></div>
      <div class="card"><a href="xg_best_bets.html">xg best_bets</a></div>
    </div>
  </div>

  <footer>
    &copy; 2025 ScottyMelloty Racing Visualizer ‚Ä¢ All rights reserved
  </footer>

  <!-- ‚úÖ Robust meta enrichment: DOM-parse race pages (avoids regex grabbing color codes like #3b9e3f) -->
  <script>
    (function () {
      const isRaceLink = (href) => {
        if (!href) return false;
        // Enrich only per-race pages like "17-12_Newcastle.html"
        return /^\d{2}-\d{2}_.+\.html$/i.test(href);
      };

      const badge = (text, cls) => {
        const s = document.createElement("span");
        s.className = "badge" + (cls ? " " + cls : "");
        s.textContent = text;
        return s;
      };

      function extractMetaFromDoc(doc) {
        // Title signals (for EP)
        const h1 = (doc.querySelector("h1")?.textContent || "").trim();
        const title = (doc.title || "").trim();
        const titleBlob = (h1 + " " + title).toLowerCase();

        const isEP =
          /ep\s*[√óx]\s*\d+/i.test(titleBlob) ||
          /extra\s*place/i.test(titleBlob) ||
          /extra[-\s]*places?/i.test(titleBlob);

        // Runners = number of rows in the main table body
        // (Your per-race pages always render df.to_html(...) => table exists)
        let runners = null;
        try {
          const trs = doc.querySelectorAll("table tbody tr");
          if (trs && trs.length) runners = trs.length;
        } catch (e) {}

        // Confidence: find "Data Confidence (Race):" and grab the span text next to it
        // This avoids pulling digits from style attributes (e.g., #3b9e3f)
        let conf = null;
        try {
          const allDivs = Array.from(doc.querySelectorAll("div"));
          const confDiv = allDivs.find(d => (d.textContent || "").includes("Data Confidence (Race):"));
          if (confDiv) {
            // usually: <div> <b>Data Confidence (Race):</b> <span>97.5%</span>
            const sp = confDiv.querySelector("span");
            const raw = (sp?.textContent || confDiv.textContent || "").replace("Data Confidence (Race):", "").trim();
            const m = raw.match(/(\d+(\.\d+)?)/);
            if (m) conf = m[1];
          }
        } catch (e) {}

        return { runners, conf, isEP };
      }

      async function enrichCard(a) {
        const href = a.getAttribute("href");
        if (!isRaceLink(href)) return;

        const card = a.closest(".card");
        if (!card) return;

        if (card.querySelector(".meta-row")) return;

        const row = document.createElement("div");
        row.className = "meta-row";
        row.appendChild(badge("‚è≥ Loading‚Ä¶"));
        card.appendChild(row);

        try {
          const res = await fetch(href, { cache: "no-store" });
          if (!res.ok) throw new Error("fetch failed: " + res.status);

          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, "text/html");
          const meta = extractMetaFromDoc(doc);

          row.innerHTML = "";

          if (meta.runners) row.appendChild(badge(`üë• ${meta.runners} runners`));
          else row.appendChild(badge("üë• runners ?"));

          if (meta.conf) {
            const c = parseFloat(meta.conf);
            const cls = isFinite(c) ? (c >= 90 ? "badge-hi" : (c <= 70 ? "badge-lo" : "")) : "";
            row.appendChild(badge(`‚úÖ ${meta.conf}%`, cls));
          } else {
            row.appendChild(badge("‚úÖ conf ?"));
          }

          if (meta.isEP) row.appendChild(badge("‚≠ê Extra Place", "badge-ep"));

        } catch (e) {
          row.innerHTML = "";
          row.appendChild(badge("‚ö† meta unavailable"));
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".card a").forEach(enrichCard);
      });
    })();
  </script>
</body>
</html>
