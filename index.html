<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Race Visualizer</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1e1e2f; color: #f5f5f5; display: flex; flex-direction: column; align-items: center; }
    header { background: linear-gradient(135deg, #222 40%, #444); width: 100%; padding: 2rem 1rem; text-align: center; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6); }
    header h1 { margin: 0; font-size: 2.5rem; color: #ffd700; letter-spacing: 1px; }
    .container { width: 100%; max-width: 1200px; padding: 2rem; }
    .container h2 { width: 100%; text-align: left; margin: 2rem 0 1rem; color: #ffd700; border-bottom: 1px solid #444; padding-bottom: 0.3rem; }
    .course-group { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; }
    .card { background: #2c2c3e; border-radius: 12px; padding: 1.5rem; text-align: center; width: 220px; transition: transform 0.2s ease, box-shadow 0.3s ease; box-shadow: 0 0 10px rgba(255, 255, 255, 0.05); }
    .card:hover { transform: translateY(-6px); box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
    .card a { text-decoration: none; color: #ffd700; font-weight: bold; font-size: 1.1rem; display: inline-block; }

    /* meta row + badges */
    .meta-row { margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.4rem; justify-content: center; }
    .badge {
      font-size: 0.78rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: #ddd;
      line-height: 1.2;
      white-space: nowrap;
    }
    .badge-ep { background: rgba(0, 200, 255, 0.14); border-color: rgba(0, 200, 255, 0.25); color: #bfefff; }
    .badge-hi { background: rgba(60, 220, 120, 0.14); border-color: rgba(60, 220, 120, 0.25); color: #c8ffd8; }
    .badge-lo { background: rgba(255, 120, 120, 0.14); border-color: rgba(255, 120, 120, 0.25); color: #ffd1d1; }
    .badge-mid { background: rgba(180, 180, 180, 0.14); border-color: rgba(180, 180, 180, 0.25); color: #e6e6e6; }

    footer { margin-top: 3rem; font-size: 0.9rem; color: #888; text-align: center; padding-bottom: 2rem; }
    @media (max-width: 600px) { .card { width: 90%; } header h1 { font-size: 1.8rem; } }
  </style>
</head>
<body>
  <header>
    <h1>üèá Race Visualizer Index</h1>
  </header>

  <div class="container">
    <h2>üèÅ Ffos_Las</h2>
    <div class="course-group">
      <div class="card"><a href="14-00_Ffos_Las.html">14:00 Ffos_Las</a></div>
      <div class="card"><a href="14-30_Ffos_Las.html">14:30 Ffos_Las</a></div>
      <div class="card"><a href="15-00_Ffos_Las.html">15:00 Ffos_Las</a></div>
      <div class="card"><a href="15-30_Ffos_Las.html">15:30 Ffos_Las</a></div>
      <div class="card"><a href="16-00_Ffos_Las.html">16:00 Ffos_Las</a></div>
      <div class="card"><a href="16-30_Ffos_Las.html">16:30 Ffos_Las</a></div>
      <div class="card"><a href="17-00_Ffos_Las.html">17:00 Ffos_Las</a></div>
    </div>

    <h2>üèÅ Huntingdon</h2>
    <div class="course-group">
      <div class="card"><a href="13-45_Huntingdon.html">13:45 Huntingdon</a></div>
      <div class="card"><a href="14-15_Huntingdon.html">14:15 Huntingdon</a></div>
      <div class="card"><a href="14-45_Huntingdon.html">14:45 Huntingdon</a></div>
      <div class="card"><a href="15-15_Huntingdon.html">15:15 Huntingdon</a></div>
      <div class="card"><a href="15-45_Huntingdon.html">15:45 Huntingdon</a></div>
      <div class="card"><a href="16-15_Huntingdon.html">16:15 Huntingdon</a></div>
      <div class="card"><a href="16-45_Huntingdon.html">16:45 Huntingdon</a></div>
    </div>


    <h2>üèÅ best_bets</h2>
    <div class="course-group">
      <div class="card"><a href="ai_best_bets.html">ai best_bets</a></div>
      <div class="card"><a href="xg_best_bets.html">xg best_bets</a></div>
    </div>
  </div>

  <footer>
    &copy; 2025 ScottyMelloty Racing Visualizer ‚Ä¢ All rights reserved
  </footer>

  <script>
    (function () {
      const isRaceLink = (href) => /^\d{2}-\d{2}_.+\.html$/i.test(href || "");

      const badge = (text, cls) => {
        const s = document.createElement("span");
        s.className = "badge" + (cls ? " " + cls : "");
        s.textContent = text;
        return s;
      };

      const pad2 = (n) => String(n).padStart(2, "0");

      const extractTimeCourseFromAnchor = (a) => {
        const txt = String(a.textContent || "").trim(); // "17:42 Newcastle"
        const m = txt.match(/^(\d{1,2})[:.](\d{2})\s+(.+)$/);
        if (!m) return null;
        const hh = pad2(m[1]);
        const mm = pad2(m[2]);
        const course = String(m[3] || "").trim();
        if (!course) return null;
        return { hhmm: `${hh}:${mm}`, course };
      };

      const normCourse = (s) =>
        String(s || "")
          .toLowerCase()
          .replace(/[_-]+/g, " ")
          .replace(/\s+/g, " ")
          .trim();

      // Extra Places file (JSON lines)
      let EP_MAP = new Map(); // "course|HH:MM" -> max places
      let EP_LOADED = false;

      async function loadExtraPlacesOnce() {
        if (EP_LOADED) return;
        EP_LOADED = true;

        const urls = [
          "extra_places.txt",
          "https://raw.githubusercontent.com/racingmodel/racing-visualizer/main/extra_places.txt"
        ];

        let txt = null;
        for (const url of urls) {
          try {
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) continue;
            txt = await res.text();
            if (txt) break;
          } catch (e) {}
        }
        if (!txt) return;

        const lines = txt.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

        for (const line of lines) {
          try {
            const obj = JSON.parse(line);
            const dt = String(obj.race_datetime || "").trim();
            const course = normCourse(obj.course || "");
            const places = parseInt(obj.places, 10);

            const tm = dt.match(/\b(\d{1,2}):(\d{2})\b/);
            if (!tm || !course) continue;

            const hh = pad2(tm[1]);
            const mm = pad2(tm[2]);
            const hhmm = `${hh}:${mm}`;
            const key = `${course}|${hhmm}`;

            const prev = EP_MAP.get(key);
            if (prev == null || (Number.isFinite(places) && places > prev)) EP_MAP.set(key, places);
          } catch (e) {}
        }
      }

      function epPlacesForAnchor(a) {
        const tc = extractTimeCourseFromAnchor(a);
        if (!tc) return null;
        const key = `${normCourse(tc.course)}|${tc.hhmm}`;
        return EP_MAP.get(key) ?? null;
      }

      function extractMetaFromDoc(doc) {
        let runners = null;
        try {
          const trs = doc.querySelectorAll("table tbody tr");
          if (trs && trs.length) runners = trs.length;
        } catch (e) {}

        let conf = null;
        try {
          const allDivs = Array.from(doc.querySelectorAll("div"));
          const confDiv = allDivs.find(d => (d.textContent || "").includes("Data Confidence (Race):"));
          if (confDiv) {
            const sp = confDiv.querySelector("span");
            const raw = (sp?.textContent || confDiv.textContent || "")
              .replace("Data Confidence (Race):", "")
              .trim();
            const m = raw.match(/(\d+(\.\d+)?)/);
            if (m) conf = m[1];
          }
        } catch (e) {}

        return { runners, conf };
      }

      async function enrichCard(a) {
        const href = a.getAttribute("href");
        if (!isRaceLink(href)) return;

        const card = a.closest(".card");
        if (!card) return;
        if (card.querySelector(".meta-row")) return;

        const row = document.createElement("div");
        row.className = "meta-row";
        row.appendChild(badge("‚è≥ Loading‚Ä¶"));
        card.appendChild(row);

        try {
          await loadExtraPlacesOnce();

          const res = await fetch(href, { cache: "no-store" });
          if (!res.ok) throw new Error("fetch failed: " + res.status);

          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, "text/html");
          const meta = extractMetaFromDoc(doc);
          const epPlaces = epPlacesForAnchor(a);

          row.innerHTML = "";

          row.appendChild(badge(meta.runners ? `${meta.runners} runners` : "runners ?"));

          if (meta.conf) {
            const c = parseFloat(meta.conf);
            if (isFinite(c) && c >= 90) {
              row.appendChild(badge(`‚úÖ ${meta.conf}%`, "badge-hi"));
            } else if (isFinite(c)) {
              const cls = (c < 70) ? "badge-lo" : "badge-mid";
              row.appendChild(badge(`‚õî ${meta.conf}%`, cls));
            } else {
              row.appendChild(badge("‚õî conf ?", "badge-mid"));
            }
          } else {
            row.appendChild(badge("‚õî conf ?", "badge-mid"));
          }

          if (epPlaces != null) {
            row.appendChild(badge(`‚≠ê EP√ó${epPlaces}`, "badge-ep"));
          }

        } catch (e) {
          row.innerHTML = "";
          row.appendChild(badge("‚ö† meta unavailable"));
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".card a").forEach(enrichCard);
      });
    })();
  </script>
</body>
</html>
